<%- include('../../layouts/header'); %>
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0">Dashboard</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item">Faqs</li>
          <li class="breadcrumb-item active"><%= title; %></li>
        </ol>
      </div>
    </div>
  </div>
</div>

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        <div class="card card-outline card-primary">
          <div class="card-header">
            <h4 class="card-title"><%= title; %></h4>
          </div>
          <div class="card-body">
            <form method="POST" data-form="true" data-url="/admin/portal/shoecares/add">
              <% if(is_update == true){ %>
                <input type="hidden" name="action_id" value="<%= action_data._id; %>">
              <% } %>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Name</label>
                    <input type="text" class="form-control" name="name" value="<% if(is_update){ %><%= action_data.name %><% } %>" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Phone</label>
                    <input type="text" class="form-control" name="phone" value="<% if(is_update){ %><%= action_data.phone %><% } %>" required>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Pick Up Date</label>
                    <input type="date" class="form-control" name="pickupdate" value="<% if(is_update){ %><%= action_data.pickupdate %><% } %>" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Pick Up Time</label>
                    <select class="form-control" name="pickuptime" required>
                      <% if(is_update){ %>
                        <option value="<%= action_data.pickuptime %>"><%= action_data.pickuptime %></option>
                      <% } else { %>
                        <option value="">Select Time</option>
                      <% } %>
                    </select>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Address</label>
                <input type="text" class="form-control" name="address" placeholder="Address" value="<% if(is_update){ %><%= action_data.address %><% } %>" required>
              </div>

              <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" name="description" placeholder="Description" required><% if(is_update){ %><%= action_data.description %><% } %></textarea>
              </div>

              <!-- Shoe Services Dynamic Section -->
             <div class="form-group">
  <label>Shoe Services</label>
  <div id="shoeServicesContainer">
    <% 
    let servicesList = is_update && Array.isArray(action_data.services) ? action_data.services : [{ name: '', price: '', service: '' }];
    servicesList.forEach(function(service){ 
    %>
      <div class="row shoe-service-item mb-3">
        <div class="col-md-4">
          <input type="text" class="form-control service-name" value="<%= service.name %>" placeholder="Shoe Name" required>
        </div>
        <div class="col-md-4">
          <input type="number" step="0.01" class="form-control price-input" value="<%= service.price %>" placeholder="Price" required>
        </div>
        <div class="col-md-4">
          <textarea class="form-control service-note" placeholder="Service Note" required><%= service.service %></textarea>
        </div>
      </div>
    <% }); %>
  </div>
  <button type="button" id="addServiceBtn" class="btn btn-success btn-sm mt-2">+ Add More</button>
</div>

<!-- Hidden total & services array -->
<input type="hidden" id="servicesInput" name="services" value='<%= JSON.stringify(servicesList) %>'>
<input type="hidden" id="payableamount" name="payableamount" value="<%= action_data.payableamount || 0 %>">

<div class="mt-2">
  <strong>Total Payable:</strong> <span id="totalPrice"><%= action_data.payableamount || 0 %></span>
</div>

 <div class="form-group mt-3">
                <label>Status</label>
                <select class="form-control" name="status" required>
                  <option value="confirm" <%= is_update && action_data.status === "confirm" ? 'selected' : '' %>>order confirm</option>
                  <option value="cancel" <%= is_update && action_data.status === "cancel" ? 'selected' : '' %>>order cancel</option>
                  <option value="Delivered" <%= is_update && action_data.status === "Delivered" ? 'selected' : '' %>>order Delivered</option>

                </select>
              </div>

              <div class="form-group mt-3">
                <label>Is Active</label>
                <select class="form-control" name="isActive" required>
                  <option value="true" <%= is_update && action_data.isActive === true ? 'selected' : '' %>>Yes</option>
                  <option value="false" <%= is_update && action_data.isActive === false ? 'selected' : '' %>>No</option>
                </select>
              </div>

              <div class="form-group">
                <button type="submit" class="btn btn-primary"><%= title; %></button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<%- include('../../layouts/footer'); %>
<script>
  // Add new row
  document.getElementById('addServiceBtn').addEventListener('click', function() {
    const container = document.getElementById('shoeServicesContainer');
    const newRow = document.createElement('div');
    newRow.classList.add('row', 'shoe-service-item', 'mb-3');
    newRow.innerHTML = `
      <div class="col-md-4">
        <input type="text" class="form-control service-name" placeholder="Shoe Name" required>
      </div>
      <div class="col-md-4">
        <input type="number" step="0.01" class="form-control price-input" placeholder="Price" required>
      </div>
      <div class="col-md-4">
        <textarea class="form-control service-note" placeholder="Service Note" required></textarea>
      </div>
    `;
    container.appendChild(newRow);
    updateServicesInput();
  });

  // Update hidden services array
  function updateServicesInput() {
    const services = [];
    document.querySelectorAll('#shoeServicesContainer .shoe-service-item').forEach(row => {
      const name = row.querySelector('.service-name').value.trim();
      const price = row.querySelector('.price-input').value.trim();
      const note = row.querySelector('.service-note').value.trim();
      services.push({ name, price, service: note });
    });
    document.getElementById('servicesInput').value = JSON.stringify(services);
  }

  // Calculate total price
  function calculateTotal() {
    let total = 0;
    document.querySelectorAll('.price-input').forEach(input => {
      total += parseFloat(input.value) || 0;
    });
    document.getElementById('totalPrice').innerText = total.toFixed(2);
    document.getElementById('payableamount').value = total.toFixed(2);
  }

  // Listen to any changes in inputs
  document.addEventListener('input', function(e) {
    if (e.target.closest('.shoe-service-item')) {
      calculateTotal();
      updateServicesInput();
    }
  });

  // Init on load
  calculateTotal();
  updateServicesInput();
</script>
